# Maintainer: Amelia While <me@anamy.gay>
pkgname=tensorflowlite
pkgver=2.19.0
pkgrel=0
pkgdesc="TensorFlow Lite runtime and libraries"
url="https://github.com/tensorflow/tensorflow"
license="Apache-2.0"
arch="all"
depends_dev="linux-headers"
makedepends="$depends_dev cmake samurai libc-dev libffi-dev clang18 python3 python3-dev git abseil-cpp-dev eigen-dev flatbuffers-dev farmhash-dev pthreadpool-dev libruy-dev cpuinfo-dev gemmlowp-dev libneon2sse fp16"
subpackages="$pkgname-dev"
source="
    tensorflow-$pkgver.tar.gz::https://github.com/tensorflow/tensorflow/archive/refs/tags/v$pkgver.tar.gz 
    flatbuffers.patch
"
depends="libstdc++ libffi abseil-cpp eigen flatbuffers farmhash pthreadpool libruy cpuinfo gemmlowp"
builddir="$srcdir"/tensorflow-$pkgver
options="!patch"

prepare() {
    cd "$builddir"
}

build() {
    cmake -DCMAKE_C_COMPILER=/usr/lib/llvm18/bin/clang \
          -DCMAKE_CXX_COMPILER=/usr/lib/llvm18/bin/clang++ \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_LIBDIR=lib \
          -DTFLITE_ENABLE_NNAPI=ON \
          -DTFLITE_ENABLE_INSTALL=ON \
          -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON \
          -DSYSTEM_FARMHASH=ON \
          -DSYSTEM_PTHREADPOOL=ON \
          -Dabsl_DIR=/usr/lib/cmake/absl \
          -DEigen3_DIR=/usr/lib/eigen3/cmake \
          -DNEON_2_SSE_DIR=/usr/lib/cmake/NEON_2_SSE \
          -DFlatBuffers_DIR=/usr/lib/cmake/flatbuffers \
          -Druy_DIR=/usr/lib/cmake/ruy \
          -DFP16_SOURCE_DIR=/usr/include \
          -Dgemmlowp_DIR=/usr/lib/cmake/gemmlowp \
          -Dcpuinfo_DIR=/usr/share/cpuinfo \
          -DCMAKE_IGNORE_PATH=/usr/lib/cmake/flatbuffers/\;/lib/cmake/flatbuffers \
          -B build -G Ninja tensorflow/lite -Wno-dev --trace-expand
    if [ -d "build/flatbuffers" ]; then
        cd build/flatbuffers && git apply --whitespace=fix $srcdir/flatbuffers.patch && cd ../..
    fi
    
    cmake --build build -j
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}
